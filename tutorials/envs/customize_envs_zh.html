<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LightZero 中如何自定义环境? &mdash; LightZero 0.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/style.css" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link href="../../_static/css/style.css" rel="stylesheet" type="text/css">

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            LightZero
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation/installation_and_quickstart.html">Installation and Quick Start Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../algos/customize_algos.html">How to Customize Your Algorithms in LightZero?</a></li>
<li class="toctree-l1"><a class="reference internal" href="customize_envs.html">How to Customize Your Environments in LightZero?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../config/config.html">How to Set Configuration Files in LightZero</a></li>
<li class="toctree-l1"><a class="reference internal" href="../logs/logs.html">LightZero’s Logging and Monitoring System</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api_doc/agent/index.html">Agent</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_doc/config/index.html">Config</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_doc/entry/index.html">Entry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_doc/envs/index.html">Envs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_doc/mcts/index.html">MCTS</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_doc/model/index.html">Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_doc/policy/index.html">Policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api_doc/worker/index.html">Worker</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">LightZero</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">LightZero 中如何自定义环境?</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/tutorials/envs/customize_envs_zh.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
    
    
  <section id="lightzero">
<h1>LightZero 中如何自定义环境?<a class="headerlink" href="#lightzero" title="Permalink to this heading"></a></h1>
<ul class="simple">
<li><p>在使用 LightZero 进行强化学习的研究或应用时，可能需要创建自定义的环境。创建自定义环境可以更好地适应特定的问题或任务，使得强化学习算法能够在特定环境中进行有效的训练。</p></li>
<li><p>一个典型的 LightZero 中的环境，请参考 <a class="reference external" href="https://github.com/opendilab/LightZero/blob/main/zoo/atari/envs/atari_lightzero_env.py">atari_lightzero_env.py</a> 。LightZero的环境设计大致基于DI-engine的<code class="docutils literal notranslate"><span class="pre">BaseEnv</span></code>类。在创建自定义环境时，我们遵循了与DI-engine相似的基本步骤。以下是 DI-engine 中创建自定义环境的文档</p>
<ul>
<li><p>https://di-engine-docs.readthedocs.io/zh_CN/latest/04_best_practice/ding_env_zh.html</p></li>
</ul>
</li>
</ul>
<section id="baseenv">
<h2>与 BaseEnv 的主要差异<a class="headerlink" href="#baseenv" title="Permalink to this heading"></a></h2>
<p>在 LightZero 中，有很多棋类环境。棋类环境由于存在玩家交替执行动作，合法动作在变化的情况，所以环境的观测状态除了棋面信息，还应包含动作掩码，当前玩家等信息。因此，LightZero 中的 <code class="docutils literal notranslate"><span class="pre">obs</span></code> 不再像 DI-engine 中那样是一个数组，而是一个字典。字典中的 <code class="docutils literal notranslate"><span class="pre">'observation'</span></code> 对应于 DI-engine 中的 <code class="docutils literal notranslate"><span class="pre">obs</span></code>，此外字典中还包含了 <code class="docutils literal notranslate"><span class="pre">'action_mask'</span></code>、<code class="docutils literal notranslate"><span class="pre">'to_play'</span></code> 等信息。为了代码的兼容性，对于非棋类环境，LightZero 同样要求环境返回的 <code class="docutils literal notranslate"><span class="pre">obs</span></code> 包含<code class="docutils literal notranslate"><span class="pre">'action_mask'</span></code>、<code class="docutils literal notranslate"><span class="pre">'to_play'</span></code>  等信息。</p>
<p>在具体的方法实现中，这种差异主要体现在下面几点：</p>
<ul class="simple">
<li><p>在 <code class="docutils literal notranslate"><span class="pre">reset</span></code> 方法中，LightZeroEnv  返回的是一个字典 <code class="docutils literal notranslate"><span class="pre">lightzero_obs_dict</span> <span class="pre">=</span> <span class="pre">{'observation':</span> <span class="pre">obs,</span> <span class="pre">'action_mask':</span> <span class="pre">action_mask,</span> <span class="pre">'to_play':</span> <span class="pre">-1}</span></code> 。</p>
<ul>
<li><p>对于非棋类环境</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">to_play</span></code> 的设置：由于非棋类环境一般只有一个玩家，因此设置 <code class="docutils literal notranslate"><span class="pre">to_play</span></code> =-1 。(我们在算法中根据该值，判断执行单player的算法逻辑 (<code class="docutils literal notranslate"><span class="pre">to_play</span></code> =-1) ，还是多player的算法逻辑 (<code class="docutils literal notranslate"><span class="pre">to_play</span></code>=N) )</p></li>
<li><p>对于 <code class="docutils literal notranslate"><span class="pre">action_mask</span></code> 的设置</p>
<ul>
<li><p>离散动作空间： <code class="docutils literal notranslate"><span class="pre">action_mask</span></code>= np.ones(self.env.action_space.n, ‘int8’) 是一个全1的numpy数组，表示所有动作都是合法动作。</p></li>
<li><p>连续动作空间： <code class="docutils literal notranslate"><span class="pre">action_mask</span></code> = None ，特殊的 None 表示环境是连续动作空间。</p></li>
</ul>
</li>
</ul>
</li>
<li><p>对于棋类环境：为了方便后续 MCTS 流程, <code class="docutils literal notranslate"><span class="pre">lightzero_obs_dict</span> </code> 中可能还会增加棋面信息 <code class="docutils literal notranslate"><span class="pre">board</span></code> 和当前玩家  <code class="docutils literal notranslate"><span class="pre">curren_player_index</span></code> 等变量。</p></li>
</ul>
</li>
<li><p>在  <code class="docutils literal notranslate"><span class="pre">step</span></code> 方法中，返回的是 <code class="docutils literal notranslate"><span class="pre">BaseEnvTimestep(lightzero_obs_dict,</span> <span class="pre">rew,</span> <span class="pre">done,</span> <span class="pre">info)</span></code> ，其中的 <code class="docutils literal notranslate"><span class="pre">lightzero_obs_dict</span></code> 包含了更新后的观察结果。</p></li>
</ul>
</section>
<section id="id1">
<h2>基本步骤<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h2>
<p>以下是创建自定义 LightZero 环境的基本步骤：</p>
<section id="id2">
<h3>1. 创建环境类<a class="headerlink" href="#id2" title="Permalink to this heading"></a></h3>
<p>首先，需要创建一个新的环境类，该类需要继承自 DI-engine 的 BaseEnv 类。例如：</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ding.envs</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseEnv</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MyCustomEnv</span><span class="p">(</span><span class="n">BaseEnv</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
</div>
</section>
<section id="init">
<h3>2. __init__方法<a class="headerlink" href="#init" title="Permalink to this heading"></a></h3>
<p>在自定义环境类中，需要定义一个初始化方法 <code class="docutils literal notranslate"><span class="pre">__init__</span></code> 。在这个方法中，需要设置一些环境的基本属性，例如观察空间、动作空间、奖励空间等。例如：</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cfg</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_init_flag</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># set other properties...</span>
</pre></div>
</div>
</section>
<section id="reset">
<h3>3. Reset 方法<a class="headerlink" href="#reset" title="Permalink to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">reset</span></code> 方法用于重置环境到一个初始状态。这个方法应该返回环境的初始观察。例如：</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># reset the environment...</span>
    <span class="n">obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_env</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
    <span class="c1"># get the action_mask according to the legal action</span>
    <span class="o">...</span>
    <span class="n">lightzero_obs_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;observation&#39;</span><span class="p">:</span> <span class="n">obs</span><span class="p">,</span> <span class="s1">&#39;action_mask&#39;</span><span class="p">:</span> <span class="n">action_mask</span><span class="p">,</span> <span class="s1">&#39;to_play&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">lightzero_obs_dict</span>
</pre></div>
</div>
</section>
<section id="step">
<h3>4. Step 方法<a class="headerlink" href="#step" title="Permalink to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">step</span></code> 方法接受一个动作作为输入，执行这个动作，并返回一个元组，包含新的观察、奖励、是否完成和其他信息。例如：</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="p">):</span>
  <span class="c1"># The core original env step.</span>
    <span class="n">obs</span><span class="p">,</span> <span class="n">rew</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cfg</span><span class="o">.</span><span class="n">continuous</span><span class="p">:</span>
        <span class="n">action_mask</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># get the action_mask according to the legal action</span>
        <span class="n">action_mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">action_space</span><span class="o">.</span><span class="n">n</span><span class="p">,</span> <span class="s1">&#39;int8&#39;</span><span class="p">)</span>
    
    <span class="n">lightzero_obs_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;observation&#39;</span><span class="p">:</span> <span class="n">obs</span><span class="p">,</span> <span class="s1">&#39;action_mask&#39;</span><span class="p">:</span> <span class="n">action_mask</span><span class="p">,</span> <span class="s1">&#39;to_play&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">}</span>
    
    <span class="bp">self</span><span class="o">.</span><span class="n">_eval_episode_return</span> <span class="o">+=</span> <span class="n">rew</span>
    <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;eval_episode_return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eval_episode_return</span>
    
    <span class="k">return</span> <span class="n">BaseEnvTimestep</span><span class="p">(</span><span class="n">lightzero_obs_dict</span><span class="p">,</span> <span class="n">rew</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id3">
<h3>5. 观察空间和动作空间<a class="headerlink" href="#id3" title="Permalink to this heading"></a></h3>
<p>在自定义环境中，需要提供观察空间和动作空间的属性。这些属性是 <code class="docutils literal notranslate"><span class="pre">gym.Space</span></code> 对象，描述了观察和动作的形状和类型。例如：</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="nd">@property</span>
<span class="k">def</span><span class="w"> </span><span class="nf">observation_space</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_observation_space</span>

<span class="nd">@property</span>
<span class="k">def</span><span class="w"> </span><span class="nf">action_space</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_action_space</span>
    
<span class="nd">@property</span>
<span class="k">def</span><span class="w"> </span><span class="nf">legal_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># get the actual legal actions</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_action_space</span><span class="o">.</span><span class="n">n</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="render">
<h3>6. render 方法<a class="headerlink" href="#render" title="Permalink to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">render</span></code> 方法会将游戏的对局演示出来，供用户查看。对于实现了 <code class="docutils literal notranslate"><span class="pre">render</span></code> 方法的环境，用户可以选择是否在执行 <code class="docutils literal notranslate"><span class="pre">step</span></code> 函数时调用 <code class="docutils literal notranslate"><span class="pre">render</span></code> 来实现每一步游戏状态的渲染。</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;image_savefile_mode&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Overview:</span>
<span class="sd">        Renders the game environment.</span>
<span class="sd">    Arguments:</span>
<span class="sd">        - mode (:obj:`str`): The rendering mode. Options are </span>
<span class="sd">        &#39;state_realtime_mode&#39;, </span>
<span class="sd">        &#39;image_realtime_mode&#39;, </span>
<span class="sd">        or &#39;image_savefile_mode&#39;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># In &#39;state_realtime_mode&#39; mode, print the current game board for rendering.</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;state_realtime_mode&quot;</span><span class="p">:</span>
        <span class="o">...</span>
    <span class="c1"># In other two modes, use a screen for rendering. </span>
    <span class="c1"># Draw the screen.</span>
    <span class="o">...</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;image_realtime_mode&quot;</span><span class="p">:</span>
        <span class="c1"># Render the picture to user&#39;s window.</span>
        <span class="o">...</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;image_savefile_mode&quot;</span><span class="p">:</span>
        <span class="c1"># Save the picture to frames.</span>
        <span class="o">...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">screen</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>
</pre></div>
</div>
<p>在 <code class="docutils literal notranslate"><span class="pre">render</span></code> 中，有三种不同的模式。</p>
<ul class="simple">
<li><p>在 <code class="docutils literal notranslate"><span class="pre">state_realtime_mode</span></code> 下，<code class="docutils literal notranslate"><span class="pre">render</span></code> 会直接打印当前状态。</p></li>
<li><p>在 <code class="docutils literal notranslate"><span class="pre">image_realtime_mode</span></code> 下， <code class="docutils literal notranslate"><span class="pre">render</span></code> 会根据一些图形素材将环境状态渲染出来，形成可视化的界面，并弹出实时的窗口展示。</p></li>
<li><p>在 <code class="docutils literal notranslate"><span class="pre">image_savefile_mode</span></code> 下， <code class="docutils literal notranslate"><span class="pre">render</span></code> 会将渲染的图像保存在 <code class="docutils literal notranslate"><span class="pre">self.frames</span></code> 中，并在对局结束时通过 <code class="docutils literal notranslate"><span class="pre">save_render_output</span></code> 将其转化为文件保存下来。
在运行时， <code class="docutils literal notranslate"><span class="pre">render</span></code> 所采取的模式取决于 <code class="docutils literal notranslate"><span class="pre">self.render_mode</span></code> 的取值。当 <code class="docutils literal notranslate"><span class="pre">self.render_mode</span></code> 取值为 <code class="docutils literal notranslate"><span class="pre">None</span></code> 时，环境不会调用 <code class="docutils literal notranslate"><span class="pre">render</span></code> 方法。</p></li>
</ul>
</section>
<section id="id4">
<h3>7. 其他方法<a class="headerlink" href="#id4" title="Permalink to this heading"></a></h3>
<p>根据需要，可能还需要定义其他方法，例如 <code class="docutils literal notranslate"><span class="pre">close</span></code> （用于关闭环境并进行清理）等。</p>
</section>
<section id="id5">
<h3>8. 注册环境<a class="headerlink" href="#id5" title="Permalink to this heading"></a></h3>
<p>最后，需要使用 <code class="docutils literal notranslate"><span class="pre">ENV_REGISTRY.register</span></code> 装饰器来注册新的环境，使得可以在配置文件中使用它。例如：</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ding.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">ENV_REGISTRY</span>

<span class="nd">@ENV_REGISTRY</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s1">&#39;my_custom_env&#39;</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MyCustomEnv</span><span class="p">(</span><span class="n">BaseEnv</span><span class="p">):</span>
    <span class="c1"># ...</span>
</pre></div>
</div>
<p>当环境注册好之后，可以在配置文件中的 <code class="docutils literal notranslate"><span class="pre">create_config</span></code> 部分指定生成相应的环境：</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">create_config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
    <span class="n">env</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span>
        <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;my_custom_env&#39;</span><span class="p">,</span>
        <span class="n">import_names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;zoo.board_games.my_custom_env.envs.my_custom_env&#39;</span><span class="p">],</span>
    <span class="p">),</span>
    <span class="o">...</span>
<span class="p">)</span>
</pre></div>
</div>
<p>其中 <code class="docutils literal notranslate"><span class="pre">type</span></code> 要设定为所注册的环境名， <code class="docutils literal notranslate"><span class="pre">import_names</span></code> 则设置为环境包的位置。</p>
<p>创建自定义环境可能需要对具体的任务和强化学习有深入的理解。在实现自定义环境时，可能需要进行一些试验和调整，以使环境能够有效地支持强化学习的训练。</p>
</section>
</section>
<section id="id6">
<h2>棋类环境的特殊方法<a class="headerlink" href="#id6" title="Permalink to this heading"></a></h2>
<p>以下是创建自定义 LightZero 棋类环境的额外步骤：</p>
<ol>
<li><p>LightZero中的棋类环境有三种不同的模式： <code class="docutils literal notranslate"><span class="pre">self_play_mode</span></code> , <code class="docutils literal notranslate"><span class="pre">play_with_bot_mode</span></code> , <code class="docutils literal notranslate"><span class="pre">eval_mode</span></code> 。这三种模式的说明如下：</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">self_play_mode</span></code>：该模式下，采取棋类环境的经典设置，每调用一次 <code class="docutils literal notranslate"><span class="pre">step</span></code> 函数，会根据传入的动作在环境中落子一次。在分出胜负的时间步，会返回+1的 reward 。在没有分出胜负的所有时间步， reward 均为0。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">play_with_bot_mode</span></code>：该模式下，每调用一次 <code class="docutils literal notranslate"><span class="pre">step</span></code> 函数，会根据传入的动作在环境中落子一次，随后调用环境中的 bot 产生一个动作，并根据 bot 的动作再落子一次。也就是说， agent 扮演了1号玩家的角色，而 bot 扮演了2号玩家的角色和 agent 对抗。在对局结束时，如果 agent 胜利，则返回+1的 reward ，如果 bot 胜利，则返回-1的 reward ，平局则 reward 为0。在其余没有分出胜负的时间步， reward 均为0。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">eval_mode</span></code>：该模式用于评估当前的 agent 的水平。具体有 bot 和 human 两种评估方法。采取 bot 评估时，和 play_with_bot_mode 中一样，会让 bot 扮演2号玩家和 agent 对抗，并根据结果计算 agent 的胜率。采取 human 模式时，则让用户扮演2号玩家，在命令行输入动作和 agent 对打。</p></li>
</ul>
<p>每种模式下，在棋局结束后，都会从1号玩家的视角记录本局的 <code class="docutils literal notranslate"><span class="pre">eval_episode_return</span></code> 信息（如果1号玩家赢了，则 <code class="docutils literal notranslate"><span class="pre">eval_episode_return</span></code> 为1，如果输了为-1，平局为0），并记录在最后一个时间步中。</p>
</li>
<li><p>在棋类环境中，随着对局的推进，可以采取的动作会不断变少，因此还需要实现 <code class="docutils literal notranslate"><span class="pre">legal_action</span></code> 方法。该方法可以用于检验玩家输入的动作是否合法，以及在 MCTS 过程中根据合法动作生成子节点。以 Connect4 环境为例，该方法会检查棋盘中的每一列是否下满，然后返回一个列表。该列表在可以落子的列取值为1，其余位置取值为0。</p></li>
</ol>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">legal_actions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
<ol class="simple">
<li><p>LightZero的棋类环境中，还需要实现一些动作生成方法，例如 <code class="docutils literal notranslate"><span class="pre">bot_action</span></code> 和 <code class="docutils literal notranslate"><span class="pre">random_action</span></code> 。其中 <code class="docutils literal notranslate"><span class="pre">bot_action</span></code> 会根据 <code class="docutils literal notranslate"><span class="pre">self.bot_action_type</span></code> 的值调取相应种类的 bot ，通过 bot 中预实现的算法生成一个动作。而 <code class="docutils literal notranslate"><span class="pre">random_action</span></code> 则会从当前的合法动作列表中随机选取一个动作返回。 <code class="docutils literal notranslate"><span class="pre">bot_action</span></code> 用于实现环境的 <code class="docutils literal notranslate"><span class="pre">play_with_bot_mode</span></code> ，而 <code class="docutils literal notranslate"><span class="pre">random_action</span></code> 则会在 agent 和 bot 选取动作时依一定概率被调用，来增加对局样本的随机性。</p></li>
</ol>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">bot_action</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">prob_random_action_in_bot</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">random_action</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bot_action_type</span> <span class="o">==</span> <span class="s1">&#39;rule&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule_bot</span><span class="o">.</span><span class="n">get_rule_bot_action</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_current_player</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">bot_action_type</span> <span class="o">==</span> <span class="s1">&#39;mcts&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mcts_bot</span><span class="o">.</span><span class="n">get_actions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">board</span><span class="p">,</span> <span class="n">player_index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_player_index</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="lightzeroenvwrapper">
<h2>LightZeroEnvWrapper<a class="headerlink" href="#lightzeroenvwrapper" title="Permalink to this heading"></a></h2>
<p>我们在 lzero/envs/wrappers 中提供了一个 <a class="reference external" href="https://github.com/opendilab/LightZero/blob/main/lzero/envs/wrappers/lightzero_env_wrapper.py">LightZeroEnvWrapper</a>。它能够将经典的 <code class="docutils literal notranslate"><span class="pre">classic_control</span></code>, <code class="docutils literal notranslate"><span class="pre">box2d</span></code> 环境包装成 LightZero 所需要的环境格式。在初始化实例时，会传入一个原始环境，这个原始环境通过父类 <code class="docutils literal notranslate"><span class="pre">gym.Wrapper</span></code> 被初始化，这使得实例可以调用原始环境中的 <code class="docutils literal notranslate"><span class="pre">render</span></code> ， <code class="docutils literal notranslate"><span class="pre">close</span></code> ， <code class="docutils literal notranslate"><span class="pre">seed</span></code> 等方法。在此基础上， <code class="docutils literal notranslate"><span class="pre">LightZeroEnvWrapper</span></code> 类重写了 <code class="docutils literal notranslate"><span class="pre">step</span></code> 和 <code class="docutils literal notranslate"><span class="pre">reset</span></code> 方法，将其输出封装成符合 LightZero 要求的字典 <code class="docutils literal notranslate"><span class="pre">lightzero_obs_dict</span></code> 。这样一来，封装后的新环境实例就满足了 LightZero 自定义环境的要求。</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">LightZeroEnvWrapper</span><span class="p">(</span><span class="n">gym</span><span class="o">.</span><span class="n">Wrapper</span><span class="p">):</span>
    <span class="c1"># overview comments</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">env</span><span class="p">:</span> <span class="n">gym</span><span class="o">.</span><span class="n">Env</span><span class="p">,</span> <span class="n">cfg</span><span class="p">:</span> <span class="n">EasyDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># overview comments</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>具体使用时，使用下面的函数，将一个 gym 环境，通过 <code class="docutils literal notranslate"><span class="pre">LightZeroEnvWrapper</span></code> 包装成 LightZero 所需要的环境格式。 <code class="docutils literal notranslate"><span class="pre">get_wrappered_env</span></code> 会返回一个匿名函数，该匿名函数每次调用都会产生一个 <code class="docutils literal notranslate"><span class="pre">DingEnvWrapper</span></code> 实例，该实例会将 <code class="docutils literal notranslate"><span class="pre">LightZeroEnvWrapper</span></code> 作为匿名函数传入，并在实例内部将原始环境封装成 LightZero 所需的格式。</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_wrappered_env</span><span class="p">(</span><span class="n">wrapper_cfg</span><span class="p">:</span> <span class="n">EasyDict</span><span class="p">,</span> <span class="n">env_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
    <span class="c1"># overview comments</span>
    <span class="o">...</span>
    <span class="k">if</span> <span class="n">wrapper_cfg</span><span class="o">.</span><span class="n">manually_discretization</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">DingEnvWrapper</span><span class="p">(</span>
            <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">env_id</span><span class="p">),</span>
            <span class="n">cfg</span><span class="o">=</span><span class="p">{</span>
                <span class="s1">&#39;env_wrapper&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="k">lambda</span> <span class="n">env</span><span class="p">:</span> <span class="n">ActionDiscretizationEnvWrapper</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">wrapper_cfg</span><span class="p">),</span> <span class="k">lambda</span> <span class="n">env</span><span class="p">:</span>
                    <span class="n">LightZeroEnvWrapper</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">wrapper_cfg</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">DingEnvWrapper</span><span class="p">(</span>
            <span class="n">gym</span><span class="o">.</span><span class="n">make</span><span class="p">(</span><span class="n">env_id</span><span class="p">),</span> <span class="n">cfg</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;env_wrapper&#39;</span><span class="p">:</span> <span class="p">[</span><span class="k">lambda</span> <span class="n">env</span><span class="p">:</span> <span class="n">LightZeroEnvWrapper</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="n">wrapper_cfg</span><span class="p">)]}</span>
        <span class="p">)</span>
</pre></div>
</div>
<p>然后在算法的主入口处中调用 <code class="docutils literal notranslate"><span class="pre">train_muzero_with_gym_env</span></code> 方法，即可使用上述包装后的 env 用于训练：</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Overview:</span>
<span class="sd">        The ``train_muzero_with_gym_env`` entry means that the environment used in the training process is generated by wrapping the original gym environment with LightZeroEnvWrapper.</span>
<span class="sd">        Users can refer to lzero/envs/wrappers for more details.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">lzero.entry</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_muzero_with_gym_env</span>
    <span class="n">train_muzero_with_gym_env</span><span class="p">([</span><span class="n">main_config</span><span class="p">,</span> <span class="n">create_config</span><span class="p">],</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_env_step</span><span class="o">=</span><span class="n">max_env_step</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="id7">
<h2>注意事项<a class="headerlink" href="#id7" title="Permalink to this heading"></a></h2>
<ul class="simple">
<li><p>状态表示：思考如何将环境状态表示为观察空间。对于简单的环境，可以直接使用低维连续状态；对于复杂的环境，可能需要使用图像或其他高维离散状态表示。</p></li>
<li><p>观察空间预处理：根据观察空间的类型，对输入数据进行适当的预处理操作，例如缩放、裁剪、灰度化、归一化等。预处理可以减少输入数据的维度，加速学习过程。</p></li>
<li><p>奖励设计：设计合理的符合目标的的奖励函数。例如，环境给出的外在奖励尽量归一化在[0, 1]。通过归一化环境给出的外在奖励，能更好的确定 RND 算法中的内在奖励权重等超参数。</p></li>
</ul>
</section>
</section>



           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, OpenDILab Contributors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>